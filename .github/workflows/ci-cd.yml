name: CI/CD - Coupe de l'Universite

on:
  push:
    branches:
      - main

jobs:
  # =============================================
  # JOB 1: Tests et Lint
  # =============================================
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ======================
      # BACKEND (FastAPI)
      # ======================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install backend dependencies
        run: |
          cd Backend
          pip install -r requirements.txt

      # Activer quand les tests seront prets
      # - name: Run backend tests
      #   run: |
      #     cd Backend
      #     pytest --maxfail=1 --disable-warnings

      # ======================
      # FRONTEND ADMIN
      # ======================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install frontend-admin deps
        run: npm ci --prefix frontend-admin

      - name: Lint frontend-admin
        run: npm run lint --prefix frontend-admin
        continue-on-error: true

      - name: Build frontend-admin
        run: npm run build --prefix frontend-admin
        env:
          NEXT_PUBLIC_API_URL: https://api.coupedeluniversite.fr

      # ======================
      # FRONTEND PUBLIC
      # ======================
      - name: Install frontend-public deps
        run: npm ci --prefix frontend-public

      - name: Lint frontend-public
        run: npm run lint --prefix frontend-public
        continue-on-error: true

      - name: Build frontend-public
        run: npm run build --prefix frontend-public
        env:
          NEXT_PUBLIC_API_URL: https://api.coupedeluniversite.fr

  # =============================================
  # JOB 2: Deploiement sur VPS
  # =============================================
  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Configuration
            PROJECT_DIR=~/coupe-universite-ucl-2026

            # Verifier si le projet existe
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "Clonage initial du projet..."
              git clone https://github.com/${{ github.repository }}.git $PROJECT_DIR
            fi

            cd $PROJECT_DIR

            # Sauvegarder les fichiers .env et certs avant le git reset
            echo "Sauvegarde des fichiers de configuration..."
            mkdir -p /tmp/env_backup
            [ -f .env ] && cp .env /tmp/env_backup/
            [ -f Backend/.env ] && cp Backend/.env /tmp/env_backup/backend.env
            [ -f frontend-admin/.env.production ] && cp frontend-admin/.env.production /tmp/env_backup/frontend-admin.env
            [ -f frontend-public/.env.production ] && cp frontend-public/.env.production /tmp/env_backup/frontend-public.env
            [ -d traefik/certs ] && cp -r traefik/certs /tmp/env_backup/

            # Pull des dernieres modifications
            echo "Mise a jour du code..."
            git fetch origin main
            git reset --hard origin/main

            # Restaurer les fichiers .env et certs
            echo "Restauration des fichiers de configuration..."
            [ -f /tmp/env_backup/.env ] && cp /tmp/env_backup/.env .env
            [ -f /tmp/env_backup/backend.env ] && cp /tmp/env_backup/backend.env Backend/.env
            [ -f /tmp/env_backup/frontend-admin.env ] && cp /tmp/env_backup/frontend-admin.env frontend-admin/.env.production
            [ -f /tmp/env_backup/frontend-public.env ] && cp /tmp/env_backup/frontend-public.env frontend-public/.env.production
            [ -d /tmp/env_backup/certs ] && mkdir -p traefik/certs && cp -r /tmp/env_backup/certs/* traefik/certs/

            # Supprimer le fichier override (pour dev local Windows uniquement)
            rm -f docker-compose.override.yml

            # Verifier que le fichier .env existe
            if [ ! -f ".env" ]; then
              echo "ERREUR: Le fichier .env n'existe pas!"
              echo "Copiez .env.example vers .env et configurez les variables."
              exit 1
            fi

            # Verifier que la base de donnees existe
            if [ ! -f "Backend/data/coupe_ucl_2026.db" ]; then
              echo "ATTENTION: Base de donnees non trouvee."
              echo "Une nouvelle base sera creee au premier demarrage."
              mkdir -p Backend/data
            fi

            # Build et deploiement avec Podman Compose
            # Note: utilise podman-compose (pas l'alias pc) car shell non-interactif
            echo "Deploiement des containers..."
            podman-compose -p coupe -f docker-compose.yml down
            podman-compose -p coupe -f docker-compose.yml up -d --build

            # Verification du deploiement
            echo "Verification des services..."
            sleep 10
            podman-compose -p coupe -f docker-compose.yml ps
            podman image prune -f

            echo "Deploiement termine!"
